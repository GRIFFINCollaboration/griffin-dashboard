<html>
    <head>
        <title>GRIFFIN MSC Builder</title>

        <!--libraries-->
        <script src='scripts/HTMLImports.min.js' type="text/javascript"></script>
        <script src='scripts/mustache.js' type="text/javascript"></script>
        <script src="scripts/jquery1-11-3.min.js" type="text/javascript"></script>

        <!--helpers-->
        <script src='scripts/helpers.js' type="text/javascript"></script>
        <script src='scripts/dataStore.js' type="text/javascript"></script>
        <script src='scripts/heartbeat.js' type="text/javascript"></script>
        <script src='scripts/colorScales.js' type="text/javascript"></script>
        <script src='scripts/canonicalMSC.js' type="text/javascript"></script>

        <!--style-->
        <link rel="stylesheet" href="css/global.css">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
        <script src="scripts/bootstrap3-3-5.min.js" type="text/javascript"></script>
        <style>
            input[type=radio].subsystem{
                display:none;
            }

            input[type=radio].subsystem:checked ~ label{
                background-color: #5cb85c;
                border-color: #4cae4c;
            }

            div.section{
                background-color: #333333;
                padding: 0em 1em 1em 1em;
                border-radius: 1em;
                margin-bottom: 1em;
            }

            a.collapse-title{
                display:block;
                margin-bottom: 2px;
            }

            div#review-and-write{
                margin-top: 1em;
            }

            input[type=number]{
                width:4em;
            }

            .alert{
                margin-top: 1em;
            }

            div.grg-custom{
                padding: 1em 0 1em 0;
            }

            div.grg-custom input[type="radio"]{
                margin-right: 1em;
                margin-left: 0.25em;
            }

        </style>

        <!--html imports-->
        <link id='brand-header' rel="import" href="templates/brand-header/brand-header.html">
        <link id='griffin-custom-unsuppressed' rel="import" href="templates/msc-builder/griffin-custom-unsuppressed.html">
        <link id='griffin-custom-suppressed' rel="import" href="templates/msc-builder/griffin-custom-suppressed.html">
        <link id='griffin-channel-row-a' rel="import" href="templates/msc-builder/griffin-channel-row-a.html">
        <link id='griffin-channel-row-b' rel="import" href="templates/msc-builder/griffin-channel-row-b.html">
        <link id='zds-custom' rel="import" href="templates/msc-builder/zds-custom.html">
        <link id='sceptar-custom' rel="import" href="templates/msc-builder/sceptar-custom.html">
        <link id='labr3-custom' rel="import" href="templates/msc-builder/labr3-custom.html">
        <link id='paces-custom' rel="import" href="templates/msc-builder/paces-custom.html">
        <link id='spice-custom' rel="import" href="templates/msc-builder/spice-custom.html">
        <link id='s2s3-custom' rel="import" href="templates/msc-builder/s2s3-custom.html">
        <link id='descant-custom' rel="import" href="templates/msc-builder/descant-custom.html">
        <link id='channel-row' rel="import" href="templates/msc-builder/channel-row.html">
        <link id='collapse-section' rel="import" href="templates/msc-builder/collapse-section.html">
        <link id='brand-footer' rel="import" href="templates/brand-footer/brand-footer.html">
    </head>

    <body>
        <div id='header'></div>

        <div class='section-wrapper'>
            <div class='col-md-8 col-md-offset-2 section'>
                <h2>Upstream Chamber</h2>
                <span>
                    <input id='USCabs' type='radio' class='subsystem' name='USC' value='abs' checked></input>
                    <label id='USCabsLabel' for='USCabs' class='btn btn-info'>Absent</label>
                </span>
                <span>
                    <input id='USCsep' type='radio' class='subsystem' name='USC' value='sep'></input>
                    <label id='USCsepLabel' for='USCsep' class='btn btn-info'>SCEPTAR</label>
                </span>
                <span>
                    <input id='USCpac' type='radio' class='subsystem' name='USC' value='pac'></input>
                    <label id='USCpacLabel' for='USCpac' class='btn btn-info'>PACES</label>
                </span>
                <span>
                    <input id='USCspi' type='radio' class='subsystem' name='USC' value='spi'></input>
                    <label id='USCspiLabel' for='USCspi' class='btn btn-info'>SPICE</label>
                </span>
            </div>

            <div class='col-md-8 col-md-offset-2 section'>
                <h2>Downstream Chamber</h2>
                <span>
                    <input id='DSCabs' type='radio' class='subsystem' name='DSC' value='abs' checked></input>
                    <label id='DSCabsLabel' for='DSCabs' class='btn btn-info'>Absent</label>
                </span>
                <span>
                    <input id='DSCsep' type='radio' class='subsystem' name='DSC' value='sep'></input>
                    <label id='DSCsepLabel' for='DSCsep' class='btn btn-info'>SCEPTAR</label>
                </span>
                <span>
                    <input id='DSCzds' type='radio' class='subsystem' name='DSC' value='zds'></input>
                    <label id='DSCzdsLabel' for='DSCzds' class='btn btn-info'>ZDS</label>
                </span>
                <span>
                    <input id='DSCs2' type='radio' class='subsystem' name='DSC' value='s2'></input>
                    <label id='DSCs2Label' for='DSCs2' class='btn btn-info'>S2</label>
                </span>
                <span>
                    <input id='DSCs3' type='radio' class='subsystem' name='DSC' value='s3'></input>
                    <label id='DSCs3Label' for='DSCs3' class='btn btn-info'>S3</label>
                </span>
            </div>

            <div class='col-md-8 col-md-offset-2 section'>
                <h2>Corona</h2>
                <span>
                    <input id='CORabs' type='radio' class='subsystem' name='COR' value='abs'></input>
                    <label id='CORabsLabel' for='CORabs' class='btn btn-info'>Absent</label>
                </span>
                <span>
                    <input id='CORgrg' type='radio' class='subsystem' name='COR' value='grg' checked></input>
                    <label id='CORgrgLabel' for='CORgrg' class='btn btn-info'>GRIFFIN</label>
                </span>

                <table id='CORgriffin' class='table top-gutter'>
                    <tr>
                        <td>Position</td>
                        <td>5</td><td>6</td><td>7</td><td>8</td><td>9</td><td>10</td><td>11</td><td>12</td>
                    </tr>
                    <tr>
                        <td>HPGe</td>
                        <td><input type='checkbox' id='grg5' value='5' class='clover' checked></input></td>
                        <td><input type='checkbox' id='grg6' value='6' class='clover' checked></input></td>
                        <td><input type='checkbox' id='grg7' value='7' class='clover' checked></input></td>
                        <td><input type='checkbox' id='grg8' value='8' class='clover' checked></input></td>
                        <td><input type='checkbox' id='grg9' value='9' class='clover' checked></input></td>
                        <td><input type='checkbox' id='grg10' value='10' class='clover' checked></input></td>
                        <td><input type='checkbox' id='grg11' value='11' class='clover' checked></input></td>
                        <td><input type='checkbox' id='grg12' value='12' class='clover' checked></input></td>
                    </tr>
                    <tr>
                        <td>Suppressors</td>
                        <td><input type='checkbox' id='grs5' value='5' class='suppressor' checked></input></td>
                        <td><input type='checkbox' id='grs6' value='6' class='suppressor' checked></input></td>
                        <td><input type='checkbox' id='grs7' value='7' class='suppressor' checked></input></td>
                        <td><input type='checkbox' id='grs8' value='8' class='suppressor' checked></input></td>
                        <td><input type='checkbox' id='grs9' value='9' class='suppressor' checked></input></td>
                        <td><input type='checkbox' id='grs10' value='10' class='suppressor' checked></input></td>
                        <td><input type='checkbox' id='grs11' value='11' class='suppressor' checked></input></td>
                        <td><input type='checkbox' id='grs12' value='12' class='suppressor' checked></input></td>
                    </tr>
                    <tr id='corona-gains'></tr>
                </table>
            </div>

            <div class='col-md-8 col-md-offset-2 section'>
                <h2>Upstream Lampshade</h2>
                <span>
                    <input id='USLabs' type='radio' class='subsystem' name='USL' value='abs'></input>
                    <label id='USLabsLabel' for='USLabs' class='btn btn-info'>Absent</label>
                </span>
                <span>
                    <input id='USLgrg' type='radio' class='subsystem' name='USL' value='grg' checked></input>
                    <label id='USLgrgLabel' for='USLgrg' class='btn btn-info'>GRIFFIN</label>
                </span>
                <span>
                    <input id='USLgrgdal' type='radio' class='subsystem' name='USL' value='grgdal'></input>
                    <label id='USLgrgdalLabel' for='USLgrgdal' class='btn btn-info'>GRIFFIN + LaBr3</label>
                </span>

                <table id='USLgriffin' class='table top-gutter'>
                    <tr>
                        <td>Position</td>
                        <td>13</td><td>14</td><td>15</td><td>16</td>
                    </tr>
                    <tr>
                        <td>HPGe</td>
                        <td><input type='checkbox' id='grg13' value='13' class='clover' checked></input></td>
                        <td><input type='checkbox' id='grg14' value='14' class='clover' checked></input></td>
                        <td><input type='checkbox' id='grg15' value='15' class='clover' checked></input></td>
                        <td><input type='checkbox' id='grg16' value='16' class='clover' checked></input></td>
                    </tr>
                    <tr>
                        <td>Suppressors</td>
                        <td><input type='checkbox' id='grs13' value='13' class='suppressor' checked></input></td>
                        <td><input type='checkbox' id='grs14' value='14' class='suppressor' checked></input></td>
                        <td><input type='checkbox' id='grs15' value='15' class='suppressor' checked></input></td>
                        <td><input type='checkbox' id='grs16' value='16' class='suppressor' checked></input></td>
                    </tr>
                    <tr id='usl-gains'></tr>
                </table>
            </div>

            <div class='col-md-8 col-md-offset-2 section'>
                <h2>Downstream Lampshade</h2>
                <span>
                    <input id='DSLabs' type='radio' class='subsystem' name='DSL' value='abs'></input>
                    <label id='DSLabsLabel' for='DSLabs' class='btn btn-info'>Absent</label>
                </span>
                <span>
                    <input id='DSLgrg' type='radio' class='subsystem' name='DSL' value='grg' checked></input>
                    <label id='DSLgrgLabel' for='DSLgrg' class='btn btn-info'>GRIFFIN</label>
                </span>
                <span>
                    <input id='DSLgrgdal' type='radio' class='subsystem' name='DSL' value='grgdal'></input>
                    <label id='DSLgrgdalLabel' for='DSLgrgdal' class='btn btn-info'>GRIFFIN + LaBr3</label>
                </span>
                <span>
                    <input id='DSLdsc' type='radio' class='subsystem' name='DSL' value='dsc'></input>
                    <label id='DSLdscLabel' for='DSLdsc' class='btn btn-info'>DESCANT</label>
                </span>

                <table id='DSLgriffin' class='table top-gutter'>
                    <tr>
                        <td>Position</td>
                        <td>1</td><td>2</td><td>3</td><td>4</td>
                    </tr>
                    <tr>
                        <td>HPGe</td>
                        <td><input type='checkbox' id='grg1' value='1' class='clover' checked></input></td>
                        <td><input type='checkbox' id='grg2' value='2' class='clover' checked></input></td>
                        <td><input type='checkbox' id='grg3' value='3' class='clover' checked></input></td>
                        <td><input type='checkbox' id='grg4' value='4' class='clover' checked></input></td>
                    </tr>
                    <tr>
                        <td>Suppressors</td>
                        <td><input type='checkbox' id='grs1' value='1' class='suppressor' checked></input></td>
                        <td><input type='checkbox' id='grs2' value='2' class='suppressor' checked></input></td>
                        <td><input type='checkbox' id='grs3' value='3' class='suppressor' checked></input></td>
                        <td><input type='checkbox' id='grs4' value='4' class='suppressor' checked></input></td>
                    </tr>
                    <tr id='dsl-gains'></tr>
                </table>
            </div>
  
            <div class='col-md-8 col-md-offset-2'>
                <button class='btn btn-lg btn-info' onclick='prepareArrays()'>Prepare New MSC Table</button>          
            </div>

        </div>

        <div id='review-and-write' class='section-wrapper hidden'>
            <div id='reviewWrap' class='col-md-8 col-md-offset-2 section'>
                <h2>Review & Customize</h2>
            </div>

            <div id='writeWrap' class='col-md-8 col-md-offset-2'>
                <button type="button" class="btn btn-primary btn-lg" data-toggle="modal" data-target="#myModal">
                    <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span> Write MSC Table to ODB
                </button>
                <div id='write-ok' class="alert alert-success hidden" role="alert">MSC table written successfully to ODB.</div>
                <div id='write-fail' class="alert alert-danger hidden" role="alert">MSC table write failed.</div>
            </div>
        </div>

        <!--are you sure modal-->
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">Overwrite MSC table in ODB?</h4>
                    </div>
                    <div class="modal-body">
                        <p>Are you sure you want to overwrite the MSC table in /DAQ/MSC in the ODB? There is no undo.</p>
                        <input type='checkbox' id='yesDefinitelyWriteODB' autocomplete='off'></input>
                        <label for='yesDefinitelyWriteODB'>I'm very sure.</label>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal" id='dismissODBmodal'>
                            <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span> Abort
                        </button>
                        <button type="button" class="btn btn-default" id='writeToODB' onclick='constructArrays()' disabled>
                            <span class="glyphicon glyphicon-pencil" aria-hidden="true"></span> Write
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id='footer'></div>

        <script>

            window.addEventListener('HTMLImportsLoaded', function(e) {

                var i, templates, detectorToggles, griffinPositions;

                validate_browser();

                ///////////////////////////
                //handle templates
                ///////////////////////////
                templates = ['brand-header', 'brand-footer', 'griffin-custom-unsuppressed', 'griffin-custom-suppressed', 'griffin-channel-row-a', 'griffin-channel-row-b', 'zds-custom', 'sceptar-custom', 'labr3-custom', 'paces-custom', 'spice-custom', 's2s3-custom', 'descant-custom', 'channel-row', 'collapse-section'];
                dataStore.templates = prepareTemplates(templates);

                //inject templates
                //header
                document.getElementById('header').innerHTML = Mustache.to_html(
                    dataStore.templates['brand-header'], 
                    {
                        'title': 'GRIFFIN MSC Builder',
                    }
                );
                //footer
                document.getElementById('footer').innerHTML = Mustache.to_html(
                    dataStore.templates['brand-footer'], 
                    {
                        
                    }
                );
                setupFooter('footerImage', 2, '#999999');

                //plug in detector toggles
                detectorToggles = document.querySelectorAll('input[type=radio]');
                for(i=0; i<detectorToggles.length; i++){
                    detectorToggles[i].onchange = manageState;
                }
                //plug in griffin position options
                griffinPositions = document.querySelectorAll('input[type=checkbox]');
                for(i=0; i<griffinPositions.length; i++){
                    griffinPositions[i].onchange = manageGRIFFIN;
                }

                //plug in the allow ODB write switch, make sure things are in the right initial state
                document.getElementById('yesDefinitelyWriteODB').onchange = this.toggleODBwrite.bind(this);
                this.toggleODBwrite();
                manageState();

            });

            function manageState(){
                // manage which detectors can be selected with which other detectors etc

                var DSC = document.querySelector('input[name="DSC"]:checked').value,
                    USC = document.querySelector('input[name="USC"]:checked').value,
                    COR = document.querySelector('input[name="COR"]:checked').value,
                    DSL = document.querySelector('input[name="DSL"]:checked').value,
                    USL = document.querySelector('input[name="USL"]:checked').value,
                    labels, inactiveLabels, i;


                // spice (and ony spice) in the USC pairs with s2 / s3 in the DSC
                // also spice services occupy the upstream lampshade position
                if(USC == 'spi'){
                    document.getElementById('DSCsepLabel').classList.add('disabled');
                    document.getElementById('DSCzdsLabel').classList.add('disabled');
                    document.getElementById('DSCs2Label').classList.remove('disabled');
                    document.getElementById('DSCs3Label').classList.remove('disabled');
                    if(DSC == 'sep' || DSC == 'zds')
                        document.getElementById('DSCabs').click();

                    document.getElementById('USLgrgLabel').classList.add('disabled');
                    document.getElementById('USLgrgdalLabel').classList.add('disabled');
                    if(USL != 'abs'){
                        document.getElementById('USLabs').click();
                        USL = 'abs'
                    }
                } else {
                    document.getElementById('DSCsepLabel').classList.remove('disabled');
                    document.getElementById('DSCzdsLabel').classList.remove('disabled');
                    document.getElementById('DSCs2Label').classList.add('disabled');
                    document.getElementById('DSCs3Label').classList.add('disabled');
                    if(DSC == 's2' || DSC == 's3')
                        document.getElementById('DSCabs').click();

                    document.getElementById('USLgrgLabel').classList.remove('disabled');
                    document.getElementById('USLgrgdalLabel').classList.remove('disabled');
                }

                // show griffin position options iff griffin is selected
                if(COR == 'grg')
                    document.getElementById('CORgriffin').classList.remove('hidden');
                else
                    document.getElementById('CORgriffin').classList.add('hidden');

                if(USL == 'grg' || USL =='grgdal')
                    document.getElementById('USLgriffin').classList.remove('hidden');
                else
                    document.getElementById('USLgriffin').classList.add('hidden')

                if(DSL == 'grg' || DSL =='grgdal')
                    document.getElementById('DSLgriffin').classList.remove('hidden');
                else
                    document.getElementById('DSLgriffin').classList.add('hidden');

                // manage clickability of labels
                labels = document.querySelectorAll('label');
                for(i=0; i<labels.length; i++)
                    labels[i].onclick = function(){return true;}
                inactiveLabels = document.querySelectorAll('label.disabled');
                for(i=0; i<inactiveLabels.length; i++){
                    inactiveLabels[i].onclick = function(e){
                        e.preventDefault();
                        e.stopPropagation();
                        return false;
                    }
                }
            }

            function manageGRIFFIN(){
                // suppressor only allowed if corresponding clover enabled
                var i;

                for(i=1; i<17; i++){
                    if(document.getElementById('grg'+i).checked){
                        document.getElementById('grs'+i).classList.remove('disabled');
                    } else {
                        document.getElementById('grs'+i).checked = false;
                        document.getElementById('grs'+i).classList.add('disabled');
                    }
                }
            }

            function prepareArrays(){
                // prepare the canonical MSC tables for the selected systems, and display and populate the corresponding customization UI.

                var DSC = document.querySelector('input[name="DSC"]:checked').value,
                    USC = document.querySelector('input[name="USC"]:checked').value,
                    COR = document.querySelector('input[name="COR"]:checked').value,
                    DSL = document.querySelector('input[name="DSL"]:checked').value,
                    USL = document.querySelector('input[name="USL"]:checked').value;

                document.getElementById('review-and-write').classList.remove('hidden');
                document.getElementById('reviewWrap').innerHTML = '<h2>Review & Customize</h2>'

                prepareGRIFFIN(DSL, COR, USL);
                prepareSCEPTAR(DSC, USC);
                prepareLaBr3(USL, DSL);
                preparePACES(USC);
                prepareSPICE(USC);                
                prepareS2S3(DSC);
                prepareDESCANT(DSL);
            }

            function prepareGRIFFIN(DSL, COR, USL){
                
                var griffinElements, clovers, suppressors, position, isSuppressed, canonical, globalGain, i;

                griffinElements = identifyGRIFFIN(DSL, COR, USL);
                clovers = griffinElements[0];
                suppressors = griffinElements[1];

                if(clovers.length>0){
                    //top level detector collapsible
                    document.getElementById('reviewWrap').innerHTML += Mustache.to_html(
                            dataStore.templates['collapse-section'], 
                            {
                                'title': 'GRIFFIN', 
                                'targetID': 'griffinWrap',
                                'buttonClass': 'btn-primary'
                            }
                        );
                }

                // global gain switch
                globalGain = '<div class="grg-custom"> <span id="grg-custom"><span>Global Gain Setting: </span>';
                globalGain += '<label for="griffin-global-gain-lo">Low: </label>'
                globalGain += '<input type="radio" name="griffin-global-gain" value="lo" onclick="manageGRGgain.call(this, \'all\')" checked></input>'
                globalGain += '<label for="griffin-global-gain-hi">High: </label>'
                globalGain += '<input type="radio" name="griffin-global-gain" value="hi" onclick="manageGRGgain.call(this, \'all\')"></input></div>'
                document.getElementById('griffinWrap').innerHTML += globalGain;

                for(i=0; i<clovers.length; i++){
                    position = clovers[i];

                    isSuppressed = suppressors.indexOf(position) != -1 // ie the suppressor will only count if the corresponding clover is there
                    canonical = configGRIFFINclover(position, isSuppressed); 

                    if(isSuppressed){
                        //set up collapsible element
                        document.getElementById('griffinWrap').innerHTML += Mustache.to_html(
                                dataStore.templates['collapse-section'], 
                                {
                                    'title': 'GRIFFIN Position ' + position, 
                                    'targetID': 'griffinTable' + (i+1),
                                    'buttonClass': 'btn-success'
                                }
                            );


                        //inject table wrap
                        document.getElementById('griffinTable'+(i+1)).innerHTML += Mustache.to_html(
                            dataStore.templates['griffin-custom-suppressed'], 
                            {
                                'position': position,
                                'key-A': 'griffin-group-' + i + '-A',
                                'key-B': 'griffin-group-' + i + '-B',
                                'key-BG': 'griffin-group-' + i + '-BG',
                                'key-RW': 'griffin-group-' + i + '-RW',
                                'M': canonicalMSC.GRIFFIN.M[position],
                                'S-A': canonicalMSC.GRIFFIN.suppressed.crystals.A.S[position],      //A-side HPGe
                                'S-B': canonicalMSC.GRIFFIN.suppressed.crystals.B.S[position],      //B-side HPGe
                                'S-BG': canonicalMSC.GRIFFIN.suppressed.suppressors.BG.S[position], //blue+green suppressors
                                'S-RW': canonicalMSC.GRIFFIN.suppressed.suppressors.RW.S[position]  //red+white suppressors
                            }
                        );

                        //insert per-channel rows
                        document.getElementById(`griffin-${position}-A-MSC`).innerHTML += Mustache.to_html(
                            dataStore.templates['griffin-channel-row-a'], 
                            {
                                'channels': canonical.slice(0,4),
                                'key': 'griffin-group-' + i + '-A',
                                'position': position
                            }
                        );
                        document.getElementById(`griffin-${position}-B-MSC`).innerHTML += Mustache.to_html(
                            dataStore.templates['griffin-channel-row-b'], 
                            {
                                'channels': canonical.slice(4,8),
                                'key': 'griffin-group-' + i + '-B',
                                'position': position
                            }
                        );
                        document.getElementById(`griffin-${position}-BG-MSC`).innerHTML += Mustache.to_html(
                            dataStore.templates['channel-row'], 
                            {
                                'channels': canonical.slice(8,18),
                                'key': 'griffin-group-' + i + '-BG',
                                'position': position
                            }
                        );
                        document.getElementById(`griffin-${position}-RW-MSC`).innerHTML += Mustache.to_html(
                            dataStore.templates['channel-row'], 
                            {
                                'channels': canonical.slice(18,28),
                                'key': 'griffin-group-' + i + '-RW',
                                'position': position
                            }
                        );
                    } else {
                        //set up collapsible element
                        document.getElementById('griffinWrap').innerHTML += Mustache.to_html(
                                dataStore.templates['collapse-section'], 
                                {
                                    'title': 'GRIFFIN Position ' + position, 
                                    'targetID': 'griffinTable' + (i+1),
                                    'buttonClass': 'btn-success'
                                }
                            );

                        //inject table wrap
                        document.getElementById('griffinTable'+(i+1)).innerHTML += Mustache.to_html(
                            dataStore.templates['griffin-custom-unsuppressed'], 
                            {
                                'position': position,
                                'key': 'griffin-group-' + i,
                                'M': canonicalMSC.GRIFFIN.M[position],
                                'S': canonicalMSC.GRIFFIN.unsuppressed.S[position]
                            }
                        );

                        //insert per-channel rows
                        document.getElementById(`griffin-${position}-MSC`).innerHTML += Mustache.to_html(
                            dataStore.templates['griffin-channel-row-a'], 
                            {
                                'channels': canonical,
                                'key': 'griffin-group-' + i,
                                'position': position
                            }
                        );
                    }
                }
            }

            function prepareSCEPTAR(DSC, USC){

                var canonical, group, i;


                canonical = configSCEPTAR(USC == 'sep', DSC == 'sep', DSC == 'zds');
                //inject table wrap
                // deal with zds if present
                if(DSC == 'zds'){

                    //set up collapsible element
                    document.getElementById('reviewWrap').innerHTML += Mustache.to_html(
                            dataStore.templates['collapse-section'], 
                            {
                                'title': 'ZDS', 
                                'targetID': 'zdsTable',
                                'buttonClass': 'btn-primary'
                            }
                        );

                    //inject table wrap
                    document.getElementById('zdsTable').innerHTML = Mustache.to_html(
                        dataStore.templates['zds-custom'], 
                        {}
                    );

                    //insert per-channel rows
                    document.getElementById('zds-MSC').innerHTML += Mustache.to_html(
                        dataStore.templates['channel-row'], 
                        {
                            'key': 'zds-group',
                            'channels': canonical.slice(0,2)
                        }
                    );

                    canonical = canonical.slice(2);                    
                } // end ZDS

                // one table for each group of 10 sceptar channels;
		// group 1 is downstream, and group 2 is upstream.
		if(DSC == 'sep' || USC == 'sep'){
                    //top level detector collapsible
                    document.getElementById('reviewWrap').innerHTML += Mustache.to_html(
                            dataStore.templates['collapse-section'], 
                            {
                                'title': 'SCEPTAR', 
                                'targetID': 'sceptarWrap',
                                'buttonClass': 'btn-primary'
                            }
                        );



                    for(i=(DSC=='sep' ? 0:2); i<(USC=='sep' ? 2:1); i++){
                        //set up collapsible element
                        if( (DSC == 'sep' && USC == 'sep') || i!=2 )
                            title = 'SCEPTAR Channels ' + (i*10+1) + ' to ' + (i+1)*10;
                        else if(DSC == 'sep')
                            title = 'SCEPTAR Channels 9 and 10';
                        else if(USC == 'sep')
                            title = 'SCEPTAR Channels 11 and 12';
                        document.getElementById('sceptarWrap').innerHTML += Mustache.to_html(
                                dataStore.templates['collapse-section'], 
                                {
                                    'title': title, 
                                    'targetID': 'sceptarTable' + (i+1),
                                    'buttonClass': 'btn-success'
                                }
                            );

                        document.getElementById('sceptarTable'+(i+1)).innerHTML += Mustache.to_html(
                            dataStore.templates['sceptar-custom'], 
                            {
                                'group': i+1, 
                                'key': 'sceptar-group-'+(i+1),
                                'M': canonicalMSC.SCEPTAR.M,
                                'S': canonicalMSC.SCEPTAR.S[i]
                            }
                        );

                        //insert per-channel rows
                        if(DSC!='sep' && i==2){
                            group = canonical.slice(6,10);
                            canonical = canonical.slice(10);
                        } else{
                            group = canonical.slice(0,10);
                            canonical = canonical.slice(10);
                        }
                        document.getElementById(`sceptar-${i+1}-MSC`).innerHTML += Mustache.to_html(
                            dataStore.templates['channel-row'], 
                            {
                                'channels': group,
                                'key': 'sceptar-group-'+(i+1)
                            }
                        );
                    }
                }                
            }

            function prepareLaBr3(USL, DSL){

                var canonical, energy, time, suppressor_group1, suppressor_group2;
                
                if(USL == 'grgdal' || DSL == 'grgdal'){
                    canonical = configLaBr3(USL == 'grgdal', DSL == 'grgdal');

                    //set up collapsible element
                    document.getElementById('reviewWrap').innerHTML += Mustache.to_html(
                            dataStore.templates['collapse-section'], 
                            {
                                'title': 'LaBr3', 
                                'targetID': 'LaBr3Table',
                                'buttonClass': 'btn-primary'
                            }
                        );

                    //inject table wrap
                    document.getElementById('LaBr3Table').innerHTML = Mustache.to_html(
                        dataStore.templates['labr3-custom'], 
                        {
                            'M': canonicalMSC.LaBr3.M,
                            'S-E': canonicalMSC.LaBr3.energy.S,
                            'S-T': canonicalMSC.LaBr3.time.S,
                            'S-S1': canonicalMSC.LaBr3.suppressors.S[0],
                            'S-S2': canonicalMSC.LaBr3.suppressors.S[1],
                            'key-E': 'labr3-group-E',
                            'key-T': 'labr3-group-T',
                            'key-S1': 'labr3-group-S1',
                            'key-S2': 'labr3-group-S2',
                            'downstream': DSL=='grgdal' ? [true] : []
                        }
                    );
                

                    if(DSL == 'grgdal' && USL=='grgdal'){                
                        energy = canonical.slice(0,8);
                        time = canonical.slice(8,16);
                        suppressor_group1 = canonical.slice(16,24);
                        suppressor_group2 = canonical.slice(24);
                    } else if (DSL == 'grgdal' || USL == 'grgdal'){
                        energy = canonical.slice(0,4);
                        time = canonical.slice(4,8);
                        if(DSL == 'grgdal'){
                            suppressor_group1 = canonical.slice(8,16);
                            suppressor_group2 = canonical.slice(16);
                        } else if (USL == 'grgdal'){
                            suppressor_group1 = [];
                            suppressor_group2 = canonical.slice(8)
                        }
                    }

                    //insert per-channel rows
                    document.getElementById('labr3-energy-MSC').innerHTML += Mustache.to_html(
                        dataStore.templates['channel-row'], 
                        {
                            'channels': energy,
                            'key': 'labr3-group-E'
                        }
                    );                
                    document.getElementById('labr3-time-MSC').innerHTML += Mustache.to_html(
                        dataStore.templates['channel-row'], 
                        {
                            'channels': time,
                            'key': 'labr3-group-T'
                        }
                    );
                    if(suppressor_group1.length > 0){
                        document.getElementById('labr3-suppressors-1-MSC').innerHTML += Mustache.to_html(
                            dataStore.templates['channel-row'], 
                            {
                                'channels': suppressor_group1,
                                'key': 'labr3-group-S1'
                            }
                        );   
                    }
                    if(suppressor_group2.length > 0){
                        document.getElementById('labr3-suppressors-2-MSC').innerHTML += Mustache.to_html(
                            dataStore.templates['channel-row'], 
                            {
                                'channels': suppressor_group2,
                                'key': 'labr3-group-S2'
                            }
                        );   
                    }
                }
            }

            function preparePACES(USC){

                var canonical;

                if(USC=='pac'){
                    canonical = configPACES();

                    //set up collapsible element
                    document.getElementById('reviewWrap').innerHTML += Mustache.to_html(
                            dataStore.templates['collapse-section'], 
                            {
                                'title': 'PACES', 
                                'targetID': 'pacesTable',
                                'buttonClass': 'btn-primary'
                            }
                        );

                    //inject table wrap
                    document.getElementById('pacesTable').innerHTML = Mustache.to_html(
                        dataStore.templates['paces-custom'], 
                        {
                            'key': 'paces-group',
                            'M': canonicalMSC.PACES.M,
                            'S': canonicalMSC.PACES.S
                        }
                    );

                    //insert per-channel rows
                    document.getElementById('paces-MSC').innerHTML += Mustache.to_html(
                        dataStore.templates['channel-row'], 
                        {
                            'key': 'paces-group',
                            'channels': canonical
                        }
                    );

                }
            }

            function prepareSPICE(USC){

                var canonical, title, i;

                if(USC == 'spi'){
                    canonical = configSPICE();

                    //top level detector collapsible
                    document.getElementById('reviewWrap').innerHTML += Mustache.to_html(
                            dataStore.templates['collapse-section'], 
                            {
                                'title': 'SPICE', 
                                'targetID': 'spiceWrap',
                                'buttonClass': 'btn-primary'
                            }
                        );

                    for(i=0; i<8; i++){
                        //set up collapsible element
                        if(i == 7)
                            title = 'SPICE Channels 112 to 119'
                        else
                            title = 'SPICE Channels ' + i*16 + ' to ' + ((i+1)*16-1)
                        document.getElementById('spiceWrap').innerHTML += Mustache.to_html(
                                dataStore.templates['collapse-section'], 
                                {
                                    'title': title, 
                                    'targetID': 'spiceTable' + (i+1),
                                    'buttonClass': 'btn-success'
                                }
                            );

                        document.getElementById('spiceTable'+(i+1)).innerHTML += Mustache.to_html(
                            dataStore.templates['spice-custom'], 
                            {
                                'group': i+1, 
                                'key': 'spice-group-'+(i+1),
                                'M': canonicalMSC.SPICE.M,
                                'S': canonicalMSC.SPICE.S[i]
                            }
                        );

                        //insert per-channel rows
                        document.getElementById(`spice-${i+1}-MSC`).innerHTML += Mustache.to_html(
                            dataStore.templates['channel-row'], 
                            {
                                'channels': canonical.slice(16*i, 16*(i+1)),
                                'key': 'spice-group-'+(i+1)
                            }
                        );
                    }
                }
            }

            function prepareS2S3(DSC){

                var canonical, type, title, group, i;

                if(DSC == 's2' || DSC == 's3'){
                    canonical = configS2S3(DSC == 's2' ? 2 : 3);
                    type = (DSC == 's2' ? 'S2' : 'S3');

                    //top level detector collapsible
                    document.getElementById('reviewWrap').innerHTML += Mustache.to_html(
                            dataStore.templates['collapse-section'], 
                            {
                                'title': type, 
                                'targetID': 's2s3Wrap',
                                'buttonClass': 'btn-primary'
                            }
                        );

                    for(i=0; i<((DSC=='s3')?4:3); i++){
                        //set up collapsible element
                        if(i == 0)
                            title = type + ' Radial Channels 0-7';
                        else if(i == 1)
                            title = type + ' Radial Channels 8-23';
                        else if(i == 2)
                            title = type + ' Azimuthal Channels 0-15';
                        else if(i == 3)
                            title = type + ' Azimuthal Channels 16-31';
                        document.getElementById('s2s3Wrap').innerHTML += Mustache.to_html(
                                dataStore.templates['collapse-section'], 
                                {
                                    'title': title, 
                                    'targetID': 's2s3Table' + (i+1),
                                    'buttonClass': 'btn-success'
                                }
                            );

                        document.getElementById('s2s3Table'+(i+1)).innerHTML += Mustache.to_html(
                            dataStore.templates['s2s3-custom'], 
                            {
                                'type': (DSC == 's2' ? 'S2' : 'S3'),
                                'group': i+1, 
                                'key': 's2s3-group-'+(i+1),
                                'M': canonicalMSC.S2S3.M,
                                'S': canonicalMSC.S2S3.S[i]
                            }
                        );

                        //insert per-channel rows
                        if(i == 0)
                            group = canonical.slice(0,8);
                        else
                            group = canonical.slice(8+(i-1)*16, 8+i*16);
                        document.getElementById(`s2s3-${i+1}-MSC`).innerHTML += Mustache.to_html(
                            dataStore.templates['channel-row'], 
                            {
                                'channels': group,
                                'key': 's2s3-group-'+(i+1)
                            }
                        );
                    }
                }
            }

            function prepareDESCANT(DSL){

                var canonical, channelsComplete, title, group, i

                //descant
                if(DSL == 'dsc'){
                    canonical = configDESCANT();

                    //top level detector collapsible
                    document.getElementById('reviewWrap').innerHTML += Mustache.to_html(
                            dataStore.templates['collapse-section'], 
                            {
                                'title': 'DESCANT', 
                                'targetID': 'descantWrap',
                                'buttonClass': 'btn-primary'
                            }
                        );

                    channelsComplete = 0;
                    for(i=0; i<canonicalMSC.DESCANT.cableBundles.length; i++){
                        //set up collapsible element
                        title = 'DESCANT Cable Bundle ' + (i+1) + ' (Channels ';
                        for(j=0; j<canonicalMSC.DESCANT.cableBundles[i].length;j++){
                            title += canonicalMSC.DESCANT.cableBundles[i][j] + ', '
                        }
                        title = title.slice(0,title.length-2) + ')'
                        document.getElementById('descantWrap').innerHTML += Mustache.to_html(
                                dataStore.templates['collapse-section'], 
                                {
                                    'title': title, 
                                    'targetID': 'descantTable' + (i+1),
                                    'buttonClass': 'btn-success'
                                }
                            );

                        document.getElementById('descantTable' + (i+1)).innerHTML += Mustache.to_html(
                            dataStore.templates['descant-custom'], 
                            {
                                'bundle': i+1, 
                                'key': 'descant-group-'+(i+1),
                                'M': canonicalMSC.DESCANT.M[i],
                                'S': canonicalMSC.DESCANT.S[i]
                            }
                        );

                        //insert per-channel rows
                        group = canonical.slice(channelsComplete, channelsComplete + canonicalMSC.DESCANT.cableBundles[i].length);
                        channelsComplete += canonicalMSC.DESCANT.cableBundles[i].length;
                        document.getElementById(`descant-${i+1}-MSC`).innerHTML += Mustache.to_html(
                            dataStore.templates['channel-row'], 
                            {
                                'key': 'descant-group-'+(i+1),
                                'channels': group
                            }
                        );
                    }
                }
            }

            function CRUDintegrity(noDataLoss){
                // display an appropriate message based on whether msc table was correctly written to the odb

                if(noDataLoss){
                    document.getElementById('write-ok').classList.remove('hidden');
                    document.getElementById('write-fail').classList.add('hidden');
                } else {
                    document.getElementById('write-ok').classList.add('hidden');
                    document.getElementById('write-fail').classList.remove('hidden');
                }
            }

            function identifyGRIFFIN(DSL, COR, USL){
                //which griffin clovers and suppressors have been requested?

                var cloverChecks, clovers = [], suppressors = [], i;

                if(DSL=='grg' || DSL=='grgdal'){
                    cloverChecks = document.getElementById('DSLgriffin').querySelectorAll('input.clover:checked');
                    for(i=0; i<cloverChecks.length; i++)
                        clovers.push(parseInt(cloverChecks[i].value,10));

                    suppressorChecks = document.getElementById('DSLgriffin').querySelectorAll('input.suppressor:checked');
                    for(i=0; i<suppressorChecks.length; i++)
                        suppressors.push(parseInt(suppressorChecks[i].value,10));
                }
                if(COR=='grg'){
                    cloverChecks = document.getElementById('CORgriffin').querySelectorAll('input.clover:checked');
                    for(i=0; i<cloverChecks.length; i++)
                        clovers.push(parseInt(cloverChecks[i].value,10));

                    suppressorChecks = document.getElementById('CORgriffin').querySelectorAll('input.suppressor:checked');
                    for(i=0; i<suppressorChecks.length; i++)
                        suppressors.push(parseInt(suppressorChecks[i].value,10));
                }
                if(USL=='grg' || USL=='grgdal'){
                    cloverChecks = document.getElementById('USLgriffin').querySelectorAll('input.clover:checked');
                    for(i=0; i<cloverChecks.length; i++)
                        clovers.push(parseInt(cloverChecks[i].value,10));

                    suppressorChecks = document.getElementById('USLgriffin').querySelectorAll('input.suppressor:checked');
                    for(i=0; i<suppressorChecks.length; i++)
                        suppressors.push(parseInt(suppressorChecks[i].value,10));
                } 

                return [clovers, suppressors];
            }

            function updateAddr(level){
                // level == 'M' or 'S'
                // onchange callback for per-group M and S inputs, sets entire group on change.

                var targets = document.getElementsByClassName(level + '-' + this.getAttribute('key')),
                    i;

                
                for(i=0; i<targets.length; i++){
                    targets[i].value = this.value;
                    targets[i].onchange();
                }
            
            }

            function toggleODBwrite(){
                //toggle odb writing permission.

                var allowed = document.getElementById('yesDefinitelyWriteODB').checked

                if(allowed)
                    document.getElementById('writeToODB').removeAttribute('disabled');
                else
                    document.getElementById('writeToODB').setAttribute('disabled', true);
            }

            function composeAddress(){
                //callback for changing an M, S or C input
                //this == input element

                var channel = this.id.slice(0,10),
                    M = document.getElementById(channel+'-M').value,
                    S = document.getElementById(channel+'-S').value,
                    C = document.getElementById(channel+'-C').value,
                    addressReport = document.getElementById(channel+'-address')
                addressReport.innerHTML = stringAddress(M,S,C);
            }


            function constructArrays(){
                // construct the arrays to write to `/DAQ/MSC` based on the current customization table

                var MSC = [], chan = [], datatype = [], gain = [], offset = [],
                    table = document.querySelectorAll('td.final-msc'),
                    i;

                for(i=0; i<table.length; i++){
                    MSC.push(parseInt(table[i].innerHTML.slice(2),16));
                    chan.push(table[i].id.slice(0,10));
                    datatype.push(parseInt(table[i].getAttribute('datatype'),10));
                    gain.push(1);
                    offset.push(0);
                }

                CRUDarrays(
                    ['/DAQ/MSC/MSC', '/DAQ/MSC/chan', '/DAQ/MSC/datatype', '/DAQ/MSC/gain', '/DAQ/MSC/offset'], 
                    [MSC, chan, datatype, gain, offset], 
                    ['short', 'string', 'int', 'float', 'float']
                );

                document.getElementById('dismissODBmodal').click();

                return [MSC, chan, datatype, gain, offset];
            }

            function manageGRGgain(group, subgroup){
                //make master-level gain switches cascade properly

                var targets, i,
                    state = this.value;

                if(group == 'all'){
                    // global master switch
                    targets = document.getElementsByClassName('grg-gain-'+state);
                } else if(subgroup == 'all'){
                    // per position master switch - unsuppressed
                    targets = document.getElementsByClassName('grg-gain-'+state+'-'+group)
                } else{
                    // per position master switch - suppressed
                    targets = document.getElementById('griffin-'+group+'-'+subgroup+'-MSC').getElementsByClassName('grg-gain-'+state+'-'+group)
                }

                for(i=0; i<targets.length; i++)
                    targets[i].click();
            }

            function updateDatatype(targetChannel, newDatatype){
                // update the hi/lo gain datatype for griffin channels

                document.getElementById(targetChannel + '-address').setAttribute('datatype', newDatatype);
            }
        </script>

    </body>
</html>
